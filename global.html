<!DOCTYPE HTML>
<script>

safari.application.addEventListener("validate", validateHandler, false);
safari.application.addEventListener("command", performCommand, false);
safari.application.addEventListener("open", hidePopover, true);
safari.application.addEventListener("deactivate", hidePopover, true);

myPop = safari.extension.createPopover("myPopoverID", safari.extension.baseURI + "popover.html", 252, 49);

function shortURL(url)
{
	// return 'clck.ru/TZ4N';
	var xmlHttp = new XMLHttpRequest();
	xmlHttp.open("GET", "http://clck.ru/--?url=" + url, false);
	xmlHttp.send(null);
	return xmlHttp.responseText;
}

function validateHandler(event)
{
    if (event.command === "short-url") 
    {
        // Disable the button if there is no URL loaded in the tab.
        event.target.disabled = !event.target.browserWindow.activeTab.url;
    }
}

function performCommand(event)
{
    switch (event.command) 
    {
    case "short-url":
    	safari.extension.settings.url = shortURL(safari.application.activeBrowserWindow.activeTab.url);
    	event.target.popover = myPop;
    	event.target.showPopover();
        break;
    }
}

function hidePopover(event)
{
    myPop.hide();
}

</script>