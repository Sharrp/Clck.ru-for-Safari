<!DOCTYPE HTML>
<script>

safari.application.addEventListener("validate", validateHandler, false);
safari.application.addEventListener("command", performCommand, false);
safari.application.addEventListener("open", hidePopover, true);
safari.application.addEventListener("deactivate", hidePopover, true);

safari.application.addEventListener("message", handleMessage, false);

popover = safari.extension.createPopover("shortURLPopover", safari.extension.baseURI + "popover.html", 252, 49);

// Short url with clck.ru
function shortURL(url)
{
	// return url.substring(url.length-8);
	var xmlHttp = new XMLHttpRequest();
	xmlHttp.open("GET", "http://clck.ru/--?url=" + url, false);
	xmlHttp.send(null);
	return xmlHttp.responseText;
}

// Show popover with shortened url of current page
function viewPopoverWithUrl(url)
{
    safari.extension.settings.url = url;
    event.target.popover = popover;
    event.target.showPopover();
}

//
// Events handling
//

function validateHandler(event)
{
    if (event.command === "short-url") 
    {
        // Disable the button if there is no URL loaded in the tab.
        event.target.disabled = !event.target.browserWindow.activeTab.url;
    }
}

function performCommand(event)
{
    switch (event.command) 
    {
    case "short-url":
        safari.extension.settings.url = shortURL(event.target.browserWindow.activeTab.url);
        event.target.popover = popover;
        event.target.showPopover();
        break;
    }
}

function hidePopover(event)
{
    popover.hide();
}

function handleMessage(event)
{
    if(event.name === "hotkey")
    {   
        safari.extension.settings.url = shortURL(safari.application.activeBrowserWindow.activeTab.url);
        var items = safari.extension.toolbarItems;
        for (var i = 0; i < items.length; ++i)
        {
            if (items[i].browserWindow == safari.application.activeBrowserWindow)
            {
                items[i].popover = popover;
                items[i].showPopover();
                break;   
            }
        }
    }
}

</script>