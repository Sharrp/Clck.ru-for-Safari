<!DOCTYPE HTML>
<script>

safari.application.addEventListener("command", performCommand, false);

function shortURL(url)
{
	// return 'clck.ru/TZ4N';
	var xmlHttp = new XMLHttpRequest();
	xmlHttp.open("GET", "http://clck.ru/--?url=" + url, false);
	xmlHttp.send(null);
	return xmlHttp.responseText;
}

function performCommand(event)
{
    switch (event.command) 
    {
    case "short-url":
    	safari.extension.settings.url = shortURL(safari.application.activeBrowserWindow.activeTab.url);
    	if (!event.target.popover)
    	{
	    	myPop = safari.extension.createPopover("myPopoverID", safari.extension.baseURI + "popover.html", 252, 49);
	    	event.target.popover = myPop;
	    }
    	event.target.showPopover();
        break;
    }
}

</script>